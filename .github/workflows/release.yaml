name: Release

on:
  push:
    branches:
      - main

jobs:
  check-env:
    runs-on: self-hosted
    steps:
      - name: Check Environment Variables
        run: |
          if [ -z "${{ secrets.VITE_AUTH0_CLIENT_ID_WEB }}" ]; then
            echo "VITE_AUTH0_CLIENT_ID_WEB is not set"
            exit 1
          fi

          if [ -z "${{ secrets.VITE_AUTH0_DOMAIN }}" ]; then
            echo "VITE_AUTH0_DOMAIN is not set"
            exit 1
          fi
          if [ -z "${{ secrets.POSTGRES_USER }}" ]; then
            echo "POSTGRES_USER is not set"
            exit 1
          fi
          if [ -z "${{ secrets.POSTGRES_PASSWORD }}" ]; then
            echo "POSTGRES_PASSWORD is not set"
            exit 1
          fi
          if [ -z "${{ secrets.CORS_WHITELIST }}" ]; then
            echo "CORS_WHITELIST is not set"
            exit 1
          fi

  docker-prune:
    needs: check-env
    runs-on: self-hosted
    steps:
      - name: Prune Docker
        run: docker system prune -af

  deploy-database:
    needs: docker-prune
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy Database
        env:
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        run: docker compose -f postgres/docker-compose.yaml up -d

  migrate-db:
    needs: deploy-database
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"

      - name: Install Dependencies
        run: npm clean-install

      - name: Migrate Database
        env:
          DATABASE_URL: postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/postgres?schema=jobber
        run: npm run db:migrate

  deploy:
    needs: migrate-db
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Write env-file for frontend
        run: |
          echo "VITE_AUTH0_CLIENT_ID_WEB=${{ secrets.VITE_AUTH0_CLIENT_ID_WEB }}" >> .env
          echo "VITE_AUTH0_DOMAIN=${{ secrets.VITE_AUTH0_DOMAIN }}" >> .env

      - name: Deploy
        env:
          DATABASE_URL: postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/postgres?schema=jobber
          CORS_WHITELIST: ${{ secrets.CORS_WHITELIST }}
        run: docker compose up -d --build

  release:
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"

      - name: Install Dependencies
        run: npm clean-install

      - name: Semantic-Release
        run: npm run release
